"use strict";var ve=Object.create;var q=Object.defineProperty;var be=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var we=Object.getPrototypeOf,Se=Object.prototype.hasOwnProperty;var a=(e,t)=>q(e,"name",{value:t,configurable:!0});var Y=(e,t)=>{for(var r in t)q(e,r,{get:t[r],enumerable:!0})},Ee=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Re(t))!Se.call(e,i)&&i!==r&&q(e,i,{get:()=>t[i],enumerable:!(o=be(t,i))||o.enumerable});return e};var Oe=(e,t,r)=>(r=e!=null?ve(we(e)):{},Ee(t||!e||!e.__esModule?q(r,"default",{value:e,enumerable:!0}):r,e));var he=require("@hono/node-server");var Ve=require("reflect-metadata"),re=require("typeorm");var j=require("typeorm");function z(e,t,r,o){var i=arguments.length,n=i<3?t:o===null?o=Object.getOwnPropertyDescriptor(t,r):o,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(e,t,r,o);else for(var u=e.length-1;u>=0;u--)(c=e[u])&&(n=(i<3?c(n):i>3?c(t,r,n):c(t,r))||n);return i>3&&n&&Object.defineProperty(t,r,n),n}a(z,"_ts_decorate");function F(e,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(e,t)}a(F,"_ts_metadata");var l=class{static{a(this,"InstrumentEntity")}id;ticker;name;type};z([(0,j.PrimaryGeneratedColumn)(),F("design:type",Number)],l.prototype,"id",void 0);z([(0,j.Column)(),F("design:type",String)],l.prototype,"ticker",void 0);z([(0,j.Column)(),F("design:type",String)],l.prototype,"name",void 0);z([(0,j.Column)(),F("design:type",String)],l.prototype,"type",void 0);l=z([(0,j.Entity)("instruments")],l);var h=require("typeorm");function w(e,t,r,o){var i=arguments.length,n=i<3?t:o===null?o=Object.getOwnPropertyDescriptor(t,r):o,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(e,t,r,o);else for(var u=e.length-1;u>=0;u--)(c=e[u])&&(n=(i<3?c(n):i>3?c(t,r,n):c(t,r))||n);return i>3&&n&&Object.defineProperty(t,r,n),n}a(w,"_ts_decorate");function O(e,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(e,t)}a(O,"_ts_metadata");var I=class{static{a(this,"MarketDataEntity")}id;instrument;instrumentId;high;low;open;close;previousClose;date};w([(0,h.PrimaryGeneratedColumn)(),O("design:type",Number)],I.prototype,"id",void 0);w([(0,h.ManyToOne)(()=>l),(0,h.JoinColumn)({name:"instrumentid"}),O("design:type",typeof l>"u"?Object:l)],I.prototype,"instrument",void 0);w([(0,h.Column)({name:"instrumentid"}),O("design:type",Number)],I.prototype,"instrumentId",void 0);w([(0,h.Column)("decimal",{precision:10,scale:2}),O("design:type",Number)],I.prototype,"high",void 0);w([(0,h.Column)("decimal",{precision:10,scale:2}),O("design:type",Number)],I.prototype,"low",void 0);w([(0,h.Column)("decimal",{precision:10,scale:2}),O("design:type",Number)],I.prototype,"open",void 0);w([(0,h.Column)("decimal",{precision:10,scale:2}),O("design:type",Number)],I.prototype,"close",void 0);w([(0,h.Column)("decimal",{precision:10,scale:2,name:"previousclose"}),O("design:type",Number)],I.prototype,"previousClose",void 0);w([(0,h.Column)(),O("design:type",typeof Date>"u"?Object:Date)],I.prototype,"date",void 0);I=w([(0,h.Entity)("marketdata")],I);var f=require("typeorm");var C=require("typeorm");function T(e,t,r,o){var i=arguments.length,n=i<3?t:o===null?o=Object.getOwnPropertyDescriptor(t,r):o,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(e,t,r,o);else for(var u=e.length-1;u>=0;u--)(c=e[u])&&(n=(i<3?c(n):i>3?c(t,r,n):c(t,r))||n);return i>3&&n&&Object.defineProperty(t,r,n),n}a(T,"_ts_decorate");function G(e,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(e,t)}a(G,"_ts_metadata");var v=class{static{a(this,"UserEntity")}id;email;accountNumber;orders};T([(0,C.PrimaryGeneratedColumn)(),G("design:type",Number)],v.prototype,"id",void 0);T([(0,C.Column)(),G("design:type",String)],v.prototype,"email",void 0);T([(0,C.Column)({name:"accountnumber"}),G("design:type",String)],v.prototype,"accountNumber",void 0);T([(0,C.OneToMany)(()=>d,e=>e.user),G("design:type",Array)],v.prototype,"orders",void 0);v=T([(0,C.Entity)("users")],v);function b(e,t,r,o){var i=arguments.length,n=i<3?t:o===null?o=Object.getOwnPropertyDescriptor(t,r):o,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(e,t,r,o);else for(var u=e.length-1;u>=0;u--)(c=e[u])&&(n=(i<3?c(n):i>3?c(t,r,n):c(t,r))||n);return i>3&&n&&Object.defineProperty(t,r,n),n}a(b,"_ts_decorate");function R(e,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(e,t)}a(R,"_ts_metadata");var d=class{static{a(this,"OrderEntity")}id;user;userId;instrument;instrumentId;side;size;price;type;status;datetime};b([(0,f.PrimaryGeneratedColumn)(),R("design:type",Number)],d.prototype,"id",void 0);b([(0,f.ManyToOne)(()=>v,e=>e.orders),(0,f.JoinColumn)({name:"userid",referencedColumnName:"id"}),R("design:type",typeof v>"u"?Object:v)],d.prototype,"user",void 0);b([(0,f.Column)({name:"userid"}),R("design:type",Number)],d.prototype,"userId",void 0);b([(0,f.ManyToOne)(()=>l),(0,f.JoinColumn)({name:"instrumentid"}),R("design:type",typeof l>"u"?Object:l)],d.prototype,"instrument",void 0);b([(0,f.Column)({name:"instrumentid"}),R("design:type",Number)],d.prototype,"instrumentId",void 0);b([(0,f.Column)(),R("design:type",String)],d.prototype,"side",void 0);b([(0,f.Column)(),R("design:type",Number)],d.prototype,"size",void 0);b([(0,f.Column)("decimal",{precision:10,scale:2}),R("design:type",Number)],d.prototype,"price",void 0);b([(0,f.Column)(),R("design:type",String)],d.prototype,"type",void 0);b([(0,f.Column)(),R("design:type",String)],d.prototype,"status",void 0);b([(0,f.Column)({type:"timestamp",default:"now()"}),R("design:type",typeof Date>"u"?Object:Date)],d.prototype,"datetime",void 0);d=b([(0,f.Entity)("orders")],d);var P=new re.DataSource({type:"postgres",url:process.env.DATABASE_URL,synchronize:!1,logging:!0,entities:[l,I,d,v]}),Xe=P.getRepository(v),D=P.getRepository(d),U=P.getRepository(l),K=P.getRepository(I);var le=require("hono"),fe=require("hono/logger");var ee=require("hono");var L={};Y(L,{OrdersService:()=>L,cashIn:()=>De,cashOut:()=>je,send:()=>xe});var $=Oe(require("tiny-invariant"));var x={};Y(x,{PortfolioService:()=>x,retrieve:()=>Ce});var ne=a((e,t,r)=>{let o=e.reduce((_,E)=>_+E.price*E.size,0),i=e.reduce((_,E)=>_+E.size,0),n=t.reduce((_,E)=>_+E.price*E.size,0),c=t.reduce((_,E)=>_+E.size,0),u=o/i,s=c*u,p=n-s,g=i-c,y=g*u,k=g*r,B=k-y,H=p+B,S=H/o*100;return{totalPurchased:o,totalSold:n,totalUnits:g,totalValue:k,realizedGainOrLoss:p,unrealizedGainOrLoss:B,totalGainOrLoss:H,totalGainPercentage:+S.toFixed(2)}},"calculateTransactionsPerformance");var oe=require("typeorm");async function Ce(e){let t=await D.find({where:{userId:e},relations:{instrument:!0}}),r=Array.from(new Set(t.map(s=>s.instrumentId))),o=await K.createQueryBuilder("marketData").where({instrumentId:(0,oe.In)(r)}).distinctOn(["instrumentId"]).orderBy("instrumentId").addOrderBy("date","DESC").getMany(),i=[];t.forEach(s=>{let p=i.findIndex(g=>g.instrumentId===s.instrumentId);if(p===-1){i.push({instrumentId:s.instrumentId,name:s.instrument.name,type:s.instrument.type,ticker:s.instrument.ticker,orders:[{type:s.type,size:s.size,side:s.side,status:s.status,price:s.price,datetime:s.datetime}]});return}i[p].orders.push({type:s.type,side:s.side,size:s.size,status:s.status,price:s.price,datetime:s.datetime})});let n=i.filter(s=>s.type==="ACCIONES").map(s=>{let p=o.find(S=>S.instrumentId===s.instrumentId),g=s.orders.filter(S=>S.side==="BUY"&&S.status==="FILLED"),y=s.orders.filter(S=>S.side==="SELL"&&S.status==="FILLED"),{totalGainPercentage:k,totalUnits:B,totalValue:H}=ne(g,y,p?.close||1);return{name:s.name,instrumentId:s.instrumentId,ticker:s.ticker,totalUnits:B,performancePercentage:k,currentPrice:+(p?.close||1),totalValue:H}}),c=i.reduce((s,p)=>p.type==="MONEDA"?s+p.orders.reduce((g,y)=>y.side==="CASH_IN"?g+y.size*y.price:g-y.size*y.price,0):s+p.orders.reduce((g,y)=>y.side==="BUY"&&["FILLED","NEW"].includes(y.status)?g-y.size*y.price:y.side==="SELL"&&y.status==="FILLED"?g+y.size*y.price:g,0),0);return{totalAccountValue:n.reduce((s,p)=>s+p.totalValue,0)+c,availableCash:c,positions:n}}a(Ce,"retrieve");var ie=require("ts-pattern");async function De(e){let t=await U.findOne({where:{ticker:e.currency}});(0,$.default)(t,`Instrument with ticker ${e.currency} not found`);let r=D.create({type:"MARKET",side:"CASH_IN",price:1,userId:e.userId,instrumentId:t.id,size:e.amount,datetime:new Date,status:"FILLED"});return await D.save(r),r}a(De,"cashIn");async function je(e){let[t,r]=await Promise.all([x.retrieve(e.userId),U.findOne({where:{ticker:e.currency}})]);(0,$.default)(r,`Instrument with ticker ${e.currency} not found`);let o=D.create({type:"MARKET",side:"CASH_OUT",price:1,userId:e.userId,instrumentId:r.id,size:e.amount,datetime:new Date,status:t.availableCash>=e.amount?"FILLED":"REJECTED"});return await D.save(o),o}a(je,"cashOut");async function xe(e){let[t,r]=await Promise.all([x.retrieve(e.userId),K.createQueryBuilder("marketData").where("marketData.instrumentId = :instrumentId",{instrumentId:e.instrumentId}).leftJoinAndSelect("marketData.instrument","instrument").orderBy("date","DESC").getOne()]);(0,$.default)(r,"Market data not found");let o=Math.floor((0,ie.match)(e.amountType).with("CASH",()=>e.amount/(e.type==="MARKET"?r.close:e.price)).with("UNITS",()=>e.amount).exhaustive()),i=e.type==="MARKET"?r.close*o:e.price*o,n=t.positions.find(s=>s.instrumentId===e.instrumentId),c=o>0?e.side==="BUY"?t.availableCash>=i:(n?.totalUnits||0)>=o:!1,u=D.create({type:e.type,size:o,status:c?e.type==="MARKET"?"FILLED":"NEW":"REJECTED",price:e.type==="MARKET"?r.close:e.price,instrumentId:e.instrumentId,side:e.side,datetime:new Date,userId:e.userId});return await D.save(u),u}a(xe,"send");var Q=require("@hono/zod-validator"),se=require("hono"),m=require("zod"),V=new se.Hono;V.post("/asset",(0,Q.zValidator)("json",m.z.union([m.z.object({type:m.z.literal("MARKET")}),m.z.object({type:m.z.literal("LIMIT"),price:m.z.number()})]).and(m.z.object({amount:m.z.number(),amountType:m.z.union([m.z.literal("CASH"),m.z.literal("UNITS")]).default("UNITS"),side:m.z.union([m.z.literal("BUY"),m.z.literal("SELL")]),instrumentId:m.z.number()}))),async e=>{let r=e.req.valid("json"),o=await L.send({...r,userId:3});return e.json({order:o})});V.post("/cash",(0,Q.zValidator)("json",m.z.object({amount:m.z.number(),currency:m.z.string(),side:m.z.union([m.z.literal("CASH_IN"),m.z.literal("CASH_OUT")])})),async e=>{let t=e.req.valid("json"),r=3,o=t.side==="CASH_IN"?await L.cashIn({userId:r,amount:t.amount,currency:t.currency}):await L.cashOut({userId:r,amount:t.amount,currency:t.currency});return e.json({order:o})});var ae=require("hono");var X=new ae.Hono;X.get("/",async e=>{let r=await x.retrieve(3);return e.json({data:r})});var pe=require("hono"),de=require("@hono/zod-validator"),N=require("zod");var ce=require("lru-cache"),ue=require("redis");function _e(){let e=new ce.LRUCache({max:1e3,ttl:3e5});return{get:a(async t=>e.get(t),"get"),set:a(async(t,r,o)=>{e.set(t,r,{ttl:o})},"set"),has:a(async t=>e.has(t),"has")}}a(_e,"createLRUCache");var J=(0,ue.createClient)({url:process.env.REDIS_URL});async function Le(){return await J.connect(),{get:a(async e=>{let t=await J.get(e);return t?JSON.parse(t):null},"get"),set:a(async(e,t,r)=>{await J.set(e,JSON.stringify(t),{EX:r/1e3})},"set"),has:a(async e=>await J.exists(e)===1,"has")}}a(Le,"createRedisCache");async function me(){if(!global.__cache)try{global.__cache=await Le()}catch(e){console.error("Failed to create Redis cache",e),console.log("Falling back to in-memory cache"),global.__cache=_e()}return global.__cache}a(me,"getCache");var M={};Y(M,{InstrumentsService:()=>M,search:()=>Ne});async function Ne(e){let{query:t,limit:r,filter:o,page:i}=e,n=i*r,c=U.createQueryBuilder("instrument");o.forEach(g=>{c.orWhere(`LOWER(instrument.${g}) LIKE :q`,{q:`%${t.toLowerCase()}%`})}),c.take(r).skip(n),c.useTransaction(!0);let[u,s]=await c.getManyAndCount(),p=s>r+n;return{data:u,info:{total:s,limit:r,page:i,nextPage:p?i+1:null,hasMore:p}}}a(Ne,"search");var Z=new pe.Hono;Z.get("/search",(0,de.zValidator)("query",N.z.object({q:N.z.string().min(1),limit:N.z.coerce.number().optional().default(10),page:N.z.coerce.number().optional().default(0),filter:N.z.enum(["name","ticker"]).array().optional().default(["name","ticker"]).or(N.z.enum(["name","ticker"]))})),async e=>{let{limit:t,page:r,q:o,filter:i}=e.req.valid("query");e.header("Cache-Control","public, max-age=300");let n=Array.isArray(i)?i:[i],c=`${o}-${t}-${r}-${n.join("-")}`,u=await me(),s=await u.get(c);if(s)return console.log("Cache hit!"),e.json(s);let p=await M.search({query:o,limit:t,filter:n,page:r});return await u.set(c,p,1e3*60*5),e.json(p)});var te=new ee.Hono,W=new ee.Hono;W.route("/orders",V);W.route("/portfolio",X);W.route("/instruments",Z);te.route("/v1",W);var ye=require("hono/cors"),ge=require("hono/timing"),Ie=require("hono/request-id"),A=new le.Hono;A.use((0,fe.logger)());A.use((0,ye.cors)());A.use((0,ge.timing)());A.use((0,Ie.requestId)());A.route("/",te);async function Ae(){try{let{isInitialized:t}=await P.initialize();t||(console.error("Failed to initialize the database connection"),process.exit(1)),console.log("Database connection is established")}catch(t){console.error("Failed to initialize the database connection",t),process.exit(1)}let e=3e3;console.log(`Server is running on port ${e}`),(0,he.serve)({fetch:A.fetch,port:e})}a(Ae,"main");Ae();
